# ============================================================================
# PERDIA EDUCATION - NETLIFY CONFIGURATION
# ============================================================================
# This file configures Netlify deployment for the Perdia Education platform
#
# Project ID: 371d61d6-ad3d-4c13-8455-52ca33d1c0d4
# Account: Perdia Education (New Netlify Account)
# Claude Code MCP: netlify-primary (DisruptorsAI)
# Last Updated: 2025-11-05
# ============================================================================

[build]
  # Build command - explicitly install all dependencies including dev
  # Note: vite, tailwindcss, and build tools moved to dependencies (not devDependencies)
  # to ensure they're installed even when NODE_ENV=production
  command = "npm install && npm run build"

  # Publish directory (Vite default output)
  publish = "dist"

  # Functions directory (for serverless functions)
  functions = "netlify/functions"

[build.environment]
  # Node version (20+ required for react-router and vite)
  NODE_VERSION = "20"

  # Secrets scanner configuration
  # Ignore example files, documentation, and build output
  # The build output (dist/) contains VITE_ prefixed env vars which are intentionally client-side
  # and safe to expose (VITE_SUPABASE_ANON_KEY is the public anonymous key, not a secret)
  SECRETS_SCAN_OMIT_PATHS = ".env.example,.claude/**/*.md,docs/**/*.md,base44-exports/**/*,dist/**/*"

# ============================================================================
# REDIRECT RULES
# ============================================================================

# Redirect all routes to index.html for client-side routing (SPA)
[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200

# API proxy to Supabase (optional - for additional security)
[[redirects]]
  from = "/api/*"
  to = "https://your-supabase-project.supabase.co/:splat"
  status = 200
  force = true

# ============================================================================
# HEADERS
# ============================================================================

# Security headers
[[headers]]
  for = "/*"
  [headers.values]
    X-Frame-Options = "DENY"
    X-XSS-Protection = "1; mode=block"
    X-Content-Type-Options = "nosniff"
    Referrer-Policy = "strict-origin-when-cross-origin"
    Permissions-Policy = "camera=(), microphone=(), geolocation=()"

# Cache static assets
[[headers]]
  for = "/assets/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# Cache fonts
[[headers]]
  for = "/fonts/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# Don't cache HTML
[[headers]]
  for = "/*.html"
  [headers.values]
    Cache-Control = "public, max-age=0, must-revalidate"

# ============================================================================
# ENVIRONMENT VARIABLES
# ============================================================================
# Set these in Netlify dashboard: Site settings > Environment variables
#
# REQUIRED (CLIENT-SIDE - VITE_ prefix):
# - VITE_SUPABASE_URL (Supabase project URL)
# - VITE_SUPABASE_ANON_KEY (public anonymous key)
#
# REQUIRED (SERVER-SIDE - NO VITE_ prefix for Functions):
# - ANTHROPIC_API_KEY (Claude API key for serverless functions)
# - OPENAI_API_KEY (OpenAI API key for serverless functions)
#
# OPTIONAL:
# - VITE_SUPABASE_SERVICE_ROLE_KEY (for serverless functions)
# - VITE_CLOUDINARY_CLOUD_NAME
# - VITE_CLOUDINARY_API_KEY
# - VITE_CLOUDINARY_API_SECRET
# - VITE_GA_MEASUREMENT_ID
# ============================================================================

# ============================================================================
# PLUGINS
# ============================================================================

# None required for basic deployment
# Add plugins here if needed (e.g., Sentry, analytics)

# ============================================================================
# CONTEXT-SPECIFIC CONFIGURATION
# ============================================================================

# Production context
[context.production]
  command = "npm install && npm run build"
  [context.production.environment]
    NODE_ENV = "production"
    VITE_APP_URL = "https://your-domain.com"

# Deploy Preview context (for PRs)
[context.deploy-preview]
  command = "npm install && npm run build"
  [context.deploy-preview.environment]
    NODE_ENV = "staging"

# Branch deploy context
[context.branch-deploy]
  command = "npm install && npm run build"

# Development context (local)
[context.dev]
  command = "npm run dev"
  targetPort = 5173
  autoLaunch = false

# ============================================================================
# NOTES
# ============================================================================
#
# PROJECT INFORMATION:
# - Project ID: 371d61d6-ad3d-4c13-8455-52ca33d1c0d4
# - Account: Perdia Education (New Netlify Account)
# - Claude Code MCP: netlify-primary (DisruptorsAI account)
# - Dashboard: https://app.netlify.com/sites/perdia-education/overview
#
# CLAUDE CODE USERS:
# - Always use netlify-primary MCP server for this project
# - Token: nfp_MnQi8ZEPrTaGqoT9TBdhba5k3BuDaQLBfb06
#
# DEPLOYMENT STEPS:
#
# 1. Connect GitHub repository to Netlify
# 2. Set environment variables in Netlify dashboard
# 3. Configure build settings (or use this file)
# 4. Deploy!
#
# AUTOMATIC DEPLOYS:
# - Pushes to main branch trigger production deploys
# - Pull requests create deploy previews
#
# CUSTOM DOMAIN:
# - Add custom domain in Netlify dashboard
# - Update VITE_APP_URL environment variable
# - Configure DNS records
#
# SERVERLESS FUNCTIONS (OPTIONAL):
# - Create functions in netlify/functions/
# - Access at: /.netlify/functions/function-name
# - Use for server-side operations (e.g., WordPress publishing)
#
# NETLIFY CLI COMMANDS:
# - netlify deploy --prod                    # Deploy to production
# - netlify env:list                         # List environment variables
# - netlify open:site                        # Open deployed site
# - netlify open:admin                       # Open Netlify dashboard
#
# ============================================================================
